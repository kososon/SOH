<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SOH Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f8fafc; }
        .active-nav { color: #3b82f6; border-top: 3px solid #3b82f6; }
        .hidden { display: none !important; }
        .bg-white { background-color: #ffffff !important; }
        .bg-slate-950 { background-color: #020617 !important; }
    </style>
</head>
<body class="bg-slate-50 flex flex-col h-screen overflow-hidden text-slate-900">

    <div id="loginPage" class="fixed inset-0 bg-slate-950 z-[100] flex items-center justify-center p-6">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm">
            <div class="text-center mb-6">
                <h2 class="text-4xl font-black text-slate-900 tracking-tighter">SOH</h2>
                <p class="text-xs text-slate-500 uppercase font-bold tracking-widest mt-1">Mobile Access</p>
            </div>
            <input type="password" id="passInput" placeholder="Password" class="w-full p-4 border-2 rounded-2xl mb-4 text-center text-xl font-bold bg-slate-50 outline-none focus:border-blue-500">
            <button onclick="login()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black shadow-lg uppercase mb-4 active:scale-95 transition-all">Login</button>
            <p class="text-center text-[10px] text-slate-400 italic font-medium">Powered By Wilson V.1.0</p>
        </div>
    </div>

    <header class="bg-white border-b p-4 shadow-sm z-10">
        <div class="flex items-center justify-between mb-3">
            <h1 class="text-2xl font-black text-blue-600 tracking-tighter">SOH</h1>
            <div class="flex items-center gap-2">
                <div id="adminTools" class="hidden">
                    <label class="bg-slate-800 text-white px-3 py-2 rounded-lg text-[10px] font-black cursor-pointer uppercase">
                        Import Excel
                        <input type="file" id="importExcel" class="hidden" accept=".xlsx, .xls">
                    </label>
                </div>
                <button onclick="logout()" id="btnLogout" class="hidden bg-red-50 text-red-600 px-3 py-2 rounded-lg text-[10px] font-black uppercase">Logout</button>
            </div>
        </div>
        <input type="text" id="globalSearch" placeholder="Cari Nama, Merk, Lot, atau QTY..." class="w-full px-4 py-2 bg-slate-100 rounded-xl outline-none text-sm font-medium focus:ring-2 focus:ring-blue-500">
    </header>

    <main class="flex-1 overflow-y-auto pb-24">
        <section id="homePage" class="p-4">
            <div id="syncStatus" class="text-[9px] font-bold text-blue-500 mb-2 hidden uppercase text-center">üîÑ Update Data Otomatis...</div>
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <table class="w-full text-left text-xs">
                    <thead class="bg-slate-50 border-b">
                        <tr class="text-slate-500 font-black uppercase tracking-tighter">
                            <th class="p-4">Nama</th><th class="p-4">Lot</th><th class="p-4">Merk</th><th class="p-4">QTY</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-100 font-bold text-slate-700">
                        <tr><td colspan="4" class="p-10 text-center italic text-slate-400">Memuat data...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="pesananPage" class="hidden p-4">
            <div class="bg-white p-5 rounded-2xl border border-slate-200">
                <label class="text-[10px] font-black text-slate-400 uppercase">Pilih Toko</label>
                <input type="text" id="searchCustomer" list="customerList" placeholder="Nama Toko..." class="w-full p-3 bg-slate-50 rounded-xl mb-4 font-bold border-2 border-slate-100 outline-none focus:border-blue-500">
                <datalist id="customerList"></datalist>
                
                <div id="orderItems" class="space-y-4"></div>
                
                <button onclick="addItemRow()" class="mt-4 w-full p-3 border-2 border-dashed border-blue-200 text-blue-600 font-black rounded-xl text-xs uppercase">+ Tambah Item</button>
                
                <div class="mt-8 p-5 bg-slate-900 rounded-2xl text-white shadow-xl">
                    <div class="flex justify-between items-end mb-4 px-1">
                        <div class="text-left">
                            <p class="text-[10px] text-slate-400 uppercase font-black">Total Item</p>
                            <p class="text-xl font-black text-blue-400" id="totalQtyDisplay">0 Pcs</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] text-slate-400 uppercase font-black">Total Harga</p>
                            <p class="text-xl font-black text-green-400" id="totalPriceDisplay">Rp 0</p>
                        </div>
                    </div>
                    
                    <div class="mb-3 text-left">
                        <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Metode Pengiriman</label>
                        <select id="shipMethod" class="w-full p-3 bg-slate-800 text-white rounded-xl text-xs font-bold outline-none border border-slate-700 focus:border-blue-500 mt-1">
                            <option value="Antar Toko">Antar Toko</option>
                            <option value="Antar Alamat">Antar Alamat</option>
                            <option value="Ambil Sendiri (Amsen)">Ambil Sendiri (Amsen)</option>
                            <option value="Tunggu Konfirmasi">Tunggu Konfirmasi</option>
                        </select>
                    </div>

                    <div class="mb-4 text-left">
                        <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Note (Opsional)</label>
                        <textarea id="orderNote" rows="2" placeholder="Contoh: Kirim besok pagi..." class="w-full p-3 bg-slate-800 text-white rounded-xl text-xs font-medium outline-none border border-slate-700 focus:border-blue-500 mt-1"></textarea>
                    </div>

                    <button onclick="generateOrder()" class="w-full bg-blue-500 py-4 rounded-xl font-black uppercase tracking-tighter active:scale-95 transition-all">Copy Pesanan</button>
                </div>
            </div>
        </section>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around p-2 pb-6 z-50">
        <button onclick="showPage('home')" id="btn-home" class="flex flex-col items-center gap-1 active-nav px-6">
            <span class="text-xl">üè†</span><span class="text-[10px] font-black uppercase">Stok</span>
        </button>
        <button onclick="showPage('pesanan')" id="btn-pesanan" class="flex flex-col items-center gap-1 px-6">
            <span class="text-xl">üìù</span><span class="text-[10px] font-black uppercase">Order</span>
        </button>
    </nav>

    <script>
        const REPO_OWNER = "kososon"; 
        const REPO_NAME = "SOH";   
        const DATA_FILE = "data.json";
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx0-vc0hN7QMMIJ6GdpI0Z_0jkCKC5t6TMqt_wJgww6ZQwphl-HySTIsMoTS7KHyvj2/exec";

        let masterData = { keramik: [], eksternal: [], customer: [] };
        let currentUser = null;

        // FUNGSI GLOBAL SEARCH (Nama, Merk, Lot, QTY)
        document.getElementById('globalSearch').addEventListener('input', function(e) {
            const val = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#tableBody tr');
            
            rows.forEach(row => {
                // Mengambil semua teks di dalam sel (td) baris tersebut
                const text = row.innerText.toLowerCase();
                // Jika salah satu kolom mengandung kata kunci, tampilkan baris
                row.style.display = text.includes(val) ? "" : "none";
            });
        });

        function login() {
            const pass = document.getElementById('passInput').value.toLowerCase();
            if (pass === 'mnu123' || pass === 'dare123') {
                currentUser = (pass === 'mnu123') ? 'admin' : 'sales';
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('btnLogout').classList.remove('hidden');
                if(currentUser === 'admin') document.getElementById('adminTools').classList.remove('hidden');
                fetchData();
                setInterval(fetchData, 30000);
            } else { alert("Password Salah!"); }
        }

        function logout() { location.reload(); }

        async function fetchData() {
            const statusEl = document.getElementById('syncStatus');
            statusEl.classList.remove('hidden');
            try {
                const url = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/${DATA_FILE}?nocache=${new Date().getTime()}`;
                const res = await fetch(url);
                if (res.ok) {
                    masterData = await res.json();
                    renderTable();
                    updateCustomerDatalist();
                }
            } catch (e) { console.error("Gagal ambil data"); }
            finally { setTimeout(() => statusEl.classList.add('hidden'), 1000); }
        }

        function renderTable() {
            const data = [...(masterData.keramik || []), ...(masterData.eksternal || [])];
            const body = document.getElementById('tableBody');
            body.innerHTML = data.map(item => `
                <tr class="border-b active:bg-slate-50">
                    <td class="p-4 font-bold">${item.Nama || '-'}</td>
                    <td class="p-4 text-slate-500">${item.Lot || '-'}</td>
                    <td class="p-4 text-[10px] uppercase">${item.Merk || '-'}</td>
                    <td class="p-4 text-blue-600 font-black">${item.QTY || 0}</td>
                </tr>
            `).join('');
            // Trigger search ulang setelah render data baru (jika input search terisi)
            const currentSearch = document.getElementById('globalSearch').value;
            if(currentSearch) document.getElementById('globalSearch').dispatchEvent(new Event('input'));
        }

        function updateCustomerDatalist() {
            const list = document.getElementById('customerList');
            if (!masterData.customer) return;
            list.innerHTML = masterData.customer.map(c => `<option value="${c['nama toko'] || c['Nama Toko'] || ''}">`).join('');
        }

        function formatCurrency(input) {
            let val = input.value.replace(/\D/g, "");
            if (val === "") { input.value = ""; return; }
            input.value = new Intl.NumberFormat('id-ID').format(val);
            calcTotal();
        }

        function validateQty(input) {
            const row = input.parentElement.parentElement;
            const namaBarang = row.querySelector('.item-name').value;
            const lotTerpilih = row.querySelector('.item-lot').value;
            const qtyInput = parseFloat(input.value) || 0;
            if (!namaBarang || !lotTerpilih) return;
            const allStok = [...(masterData.keramik || []), ...(masterData.eksternal || [])];
            const dataBarang = allStok.find(s => s.Nama === namaBarang && s.Lot === lotTerpilih);
            if (dataBarang) {
                const stokTersedia = parseFloat(dataBarang.QTY) || 0;
                if (qtyInput > stokTersedia) {
                    alert(`‚ö†Ô∏è Stok tidak cukup!\nStok Tersedia: ${stokTersedia}`);
                    input.value = stokTersedia;
                }
            }
            calcTotal();
        }

        function addItemRow() {
            const container = document.getElementById('orderItems');
            const id = Date.now();
            const allStok = [...(masterData.keramik || []), ...(masterData.eksternal || [])];
            const uniqueNames = [...new Set(allStok.map(s => s.Nama))];
            const div = document.createElement('div');
            div.className = "bg-slate-50 p-4 rounded-xl border border-slate-100 relative";
            div.innerHTML = `
                <button onclick="this.parentElement.remove(); calcTotal();" class="absolute -top-2 -right-2 bg-red-500 text-white w-6 h-6 rounded-full text-xs font-black">√ó</button>
                <input type="text" list="stok-${id}" onchange="updateLotOptions(this)" placeholder="Pilih Item..." class="item-name w-full p-2 rounded-lg border-2 border-white mb-2 font-bold text-sm outline-none">
                <datalist id="stok-${id}">${uniqueNames.map(n => `<option value="${n}">`).join('')}</datalist>
                <div class="grid grid-cols-2 gap-2">
                    <select class="item-lot p-2 rounded-lg border-2 border-white text-xs font-bold outline-none" onchange="validateQty(this.parentElement.querySelector('.item-qty'))">
                        <option value="">Pilih Lot</option>
                    </select>
                    <input type="number" oninput="validateQty(this)" placeholder="QTY" class="item-qty p-2 rounded-lg border-2 border-white text-center font-black text-blue-600 outline-none">
                </div>
                <input type="text" oninput="formatCurrency(this)" placeholder="Harga Satuan" class="item-price w-full p-2 rounded-lg border-2 border-white mt-2 font-bold text-sm outline-none">
            `;
            container.appendChild(div);
        }

        function updateLotOptions(input) {
            const row = input.parentElement;
            const lotSelect = row.querySelector('.item-lot');
            const qtyInput = row.querySelector('.item-qty');
            const allStok = [...(masterData.keramik || []), ...(masterData.eksternal || [])];
            const filtered = allStok.filter(s => s.Nama === input.value);
            lotSelect.innerHTML = '<option value="">Pilih Lot</option>' + filtered.map(f => `<option value="${f.Lot}">${f.Lot} (Sisa: ${f.QTY})</option>`).join('');
            if(qtyInput.value) validateQty(qtyInput);
        }

        function calcTotal() {
            let totalHarga = 0;
            let totalQty = 0;
            document.querySelectorAll('#orderItems > div').forEach(row => {
                const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                const priceRaw = row.querySelector('.item-price').value.replace(/\./g, "");
                const price = parseFloat(priceRaw) || 0;
                totalQty += qty;
                totalHarga += (qty * price);
            });
            document.getElementById('totalQtyDisplay').innerText = totalQty + " Pcs";
            document.getElementById('totalPriceDisplay').innerText = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(totalHarga);
        }

        async function generateOrder() {
            const customer = document.getElementById('searchCustomer').value;
            const shipMethod = document.getElementById('shipMethod').value;
            const note = document.getElementById('orderNote').value.trim();
            if(!customer) return alert("Pilih Toko dulu!");
            
            let text = `Pesanan via Whatsapp Toko : *${customer}*\n`;
            text += `---------------\n`;
            text += `*Motif / Lot / QTY / Harga*\n`;
            
            let itemsReport = ""; 
            
            document.querySelectorAll('#orderItems > div').forEach(row => {
                const motif = row.querySelector('.item-name').value;
                const lot = row.querySelector('.item-lot').value;
                const qty = row.querySelector('.item-qty').value;
                const harga = row.querySelector('.item-price').value;
                
                if(motif && qty) {
                    text += `${motif} / ${lot} / ${qty} / Rp ${harga}\n`;
                    itemsReport += `${motif} (L:${lot})[${qty}]; `; 
                }
            });
            
            const totalQty = document.getElementById('totalQtyDisplay').innerText;
            const totalHarga = document.getElementById('totalPriceDisplay').innerText;
            const now = new Date();
            const timestamp = now.toLocaleString('id-ID', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }).replace(/\./g, ':');

            text += `---------------\n`;
            text += `*Total Qty : ${totalQty}*\n`;
            text += `*Total Pesanan : ${totalHarga}*\n`;
            text += `Metode : ${shipMethod}\n`;
            if(note !== "") text += `Note : ${note}\n`;
            text += `\nPekanbaru , ${timestamp}`;
            
            navigator.clipboard.writeText(text);
            alert("Pesanan disalin! Mengirim laporan...");

            try {
                fetch(GOOGLE_SCRIPT_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        sales: currentUser,
                        customer: customer,
                        items: itemsReport + (note ? " | Note: " + note : ""),
                        total: totalHarga + " (" + totalQty + ") [" + shipMethod + "]"
                    })
                });
            } catch (e) { console.error("Gagal lapor:", e); }
        }

        function showPage(p) {
            document.getElementById('homePage').classList.toggle('hidden', p !== 'home');
            document.getElementById('pesananPage').classList.toggle('hidden', p !== 'pesanan');
            document.getElementById('btn-home').classList.toggle('active-nav', p === 'home');
            document.getElementById('btn-pesanan').classList.toggle('active-nav', p === 'pesanan');
        }
    </script>
</body>
</html>
