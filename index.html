<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SOH Mobile MNU Pekanbaru</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f8fafc; }
        .active-nav { color: #3b82f6; border-top: 3px solid #3b82f6; }
        .hidden { display: none !important; }
        .bg-white { background-color: #ffffff !important; }
    </style>
</head>
<body class="bg-slate-50 flex flex-col h-screen overflow-hidden text-slate-900">

    <div id="loginPage" class="fixed inset-0 bg-slate-950 z-[100] flex items-center justify-center p-6">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-4xl font-black text-slate-900 tracking-tighter mb-6">SOH</h2>
            <input type="password" id="passInput" placeholder="Password" class="w-full p-4 border-2 rounded-2xl mb-4 text-center text-xl font-bold bg-slate-50 outline-none focus:border-blue-500">
            <button onclick="login()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black uppercase shadow-lg active:scale-95 transition-all">Login</button>
        </div>
    </div>

    <header class="bg-white border-b p-4 shadow-sm z-10">
        <div class="flex items-center justify-between mb-3">
            <h1 class="text-2xl font-black text-blue-600 tracking-tighter">SOH</h1>
            <div id="adminTools" class="hidden flex gap-1">
                <button onclick="setNewToken()" class="bg-slate-200 text-slate-700 px-2 py-2 rounded-lg text-[9px] font-black uppercase">Token</button>
                <button onclick="clearData()" class="bg-red-600 text-white px-2 py-2 rounded-lg text-[9px] font-black uppercase">Hapus</button>
                <label class="bg-slate-800 text-white px-2 py-2 rounded-lg text-[9px] font-black cursor-pointer uppercase">
                    Import
                    <input type="file" id="importExcel" class="hidden" accept=".xlsx, .xls">
                </label>
            </div>
            <button onclick="logout()" id="btnLogout" class="hidden bg-red-50 text-red-600 px-3 py-2 rounded-lg text-[10px] font-black uppercase">Logout</button>
        </div>
        
        <div class="space-y-2">
            <input type="text" id="globalSearch" placeholder="Cari Merk, Lot, atau Ukuran..." class="w-full px-4 py-2 bg-slate-100 rounded-xl outline-none text-sm font-medium focus:ring-2 focus:ring-blue-500">
        </div>
    </header>

    <main class="flex-1 overflow-y-auto pb-24">
        <section id="homePage" class="p-4">
            <div id="syncStatus" class="text-[9px] font-bold text-blue-500 mb-2 hidden uppercase text-center">üîÑ Proses Sinkronisasi...</div>
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <table class="w-full text-left text-xs">
                    <thead class="bg-slate-50 border-b">
                        <tr class="text-slate-500 font-black uppercase tracking-tighter">
                            <th class="p-4">Nama</th><th class="p-4">Lot</th><th class="p-4">Merk</th><th class="p-4">Ukuran</th><th class="p-4">QTY</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-100 font-bold text-slate-700">
                        <tr><td colspan="5" class="p-10 text-center italic text-slate-400">Silahkan login untuk melihat data</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        const REPO_OWNER = "kososon"; 
        const REPO_NAME = "SOH";   
        const DATA_FILE = "data.json";

        let masterData = { keramik: [], eksternal: [], customer: [] };
        let currentUser = null;

        function login() {
            const pass = document.getElementById('passInput').value.toUpperCase();
            const users = { 'TEAM123': 'admin', 'ARI123': 'Arifin', 'MAU123': 'Maulana' };

            if (users[pass]) {
                currentUser = users[pass];
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('btnLogout').classList.remove('hidden');
                if(currentUser === 'admin') document.getElementById('adminTools').classList.remove('hidden');
                fetchData();
            } else { alert("Password Salah!"); }
        }

        function setNewToken() {
            const token = prompt("Masukkan GitHub Token:");
            if (token) { localStorage.setItem('gh_token', token); alert("Token Disimpan!"); }
        }

        function logout() { location.reload(); }

        async function fetchData() {
            try {
                const url = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/${DATA_FILE}?nocache=${new Date().getTime()}`;
                const res = await fetch(url);
                if (res.ok) {
                    masterData = await res.json();
                    renderTable();
                }
            } catch (e) { console.error("Fetch error"); }
        }

        function renderTable() {
            const data = [...(masterData.keramik || []), ...(masterData.eksternal || [])];
            const body = document.getElementById('tableBody');
            if (data.length === 0) {
                body.innerHTML = '<tr><td colspan="5" class="p-10 text-center italic text-slate-400">Data Kosong</td></tr>';
                return;
            }
            body.innerHTML = data.map(item => `
                <tr class="border-b">
                    <td class="p-4 font-bold">${item.Nama || '-'}</td>
                    <td class="p-4 text-slate-500">${item.Lot || '-'}</td>
                    <td class="p-4 text-[10px] uppercase">${item.Merk || '-'}</td>
                    <td class="p-4 text-[10px] text-slate-400">${item.Ukuran || '-'}</td>
                    <td class="p-4 text-blue-600 font-black">${item.QTY || 0}</td>
                </tr>
            `).join('');
        }

        // FUNGSI IMPORT YANG DIPERBAIKI
        document.getElementById('importExcel').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    let sheetFound = false;
                    workbook.SheetNames.forEach(sheetName => {
                        const lowName = sheetName.toLowerCase();
                        // Mendukung nama: keramik, eksternal, customer, Data_Keramik, Data_Customer
                        if (lowName.includes('keramik')) {
                            masterData.keramik = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                            sheetFound = true;
                        } else if (lowName.includes('eksternal')) {
                            masterData.eksternal = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                            sheetFound = true;
                        } else if (lowName.includes('customer')) {
                            masterData.customer = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                            sheetFound = true;
                        }
                    });

                    if (!sheetFound) {
                        alert("Gagal: Nama Sheet di Excel tidak dikenali! Gunakan nama 'keramik' atau 'customer'.");
                    } else {
                        alert("Berhasil membaca file. Memulai upload ke GitHub...");
                        updateGitHub();
                    }
                } catch (err) {
                    alert("Error membaca file: " + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        });

        async function updateGitHub() {
            const token = localStorage.getItem('gh_token');
            if (!token) {
                alert("Token belum diisi! Klik tombol Token dulu.");
                return;
            }

            const statusEl = document.getElementById('syncStatus');
            statusEl.classList.remove('hidden');

            try {
                const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE}`;
                
                // 1. Ambil SHA file lama
                const getRes = await fetch(url, { headers: { "Authorization": `token ${token}` } });
                const fileInfo = await getRes.json();
                
                if (!getRes.ok) throw new Error("Gagal ambil info file dari GitHub.");

                // 2. Upload Data Baru
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(masterData, null, 2))));
                const putRes = await fetch(url, {
                    method: "PUT",
                    headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        message: "Update SOH via Web",
                        content: content,
                        sha: fileInfo.sha
                    })
                });

                if (putRes.ok) {
                    alert("‚úÖ DATA BERHASIL TERUPDATE DI GITHUB!");
                    renderTable();
                } else {
                    const errorData = await putRes.json();
                    alert("‚ùå Gagal Update GitHub: " + errorData.message);
                }
            } catch (err) {
                alert("Kesalahan Sistem: " + err.message);
            } finally {
                statusEl.classList.add('hidden');
            }
        }

        function clearData() {
            if (confirm("Hapus stok?")) {
                masterData.keramik = [];
                masterData.eksternal = [];
                updateGitHub();
            }
        }
    </script>
</body>
</html>
