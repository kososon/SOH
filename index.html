<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOH - System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .active-tab { border-left: 4px solid #3b82f6; background-color: #1e293b; color: #60a5fa; }
        .hidden { display: none; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-gray-100 flex h-screen overflow-hidden">

    <nav class="w-64 bg-slate-900 text-white flex flex-col p-5 shadow-2xl z-20">
        <div class="mb-10 text-center">
            <h1 class="text-3xl font-black text-blue-500 tracking-tighter">SOH</h1>
            <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Inventory & Order System</p>
        </div>
        
        <div class="space-y-2 flex-1">
            <button onclick="showPage('home')" id="btn-home" class="w-full py-3 px-4 rounded text-left hover:bg-slate-800 transition active-tab font-bold text-sm">üè† DAFTAR STOK</button>
            <button onclick="showPage('pesanan')" id="btn-pesanan" class="w-full py-3 px-4 rounded text-left hover:bg-slate-800 transition font-bold text-sm">üìù BUAT PESANAN</button>
        </div>

        <div class="pt-5 border-t border-slate-700">
            <p id="userStatus" class="text-xs font-mono text-green-400"></p>
            <button onclick="location.reload()" class="text-xs text-red-400 mt-2 block hover:underline italic">Logout System</button>
        </div>
    </nav>

    <main class="flex-1 flex flex-col overflow-hidden relative">
        
        <div id="loginPage" class="fixed inset-0 bg-slate-950 z-[100] flex items-center justify-center">
            <div class="bg-white p-10 rounded-3xl shadow-2xl w-96 border border-slate-200">
                <div class="text-center mb-8">
                    <h2 class="text-4xl font-black text-slate-900 mb-2">SOH</h2>
                    <p class="text-sm text-slate-500 font-medium">Authentication Required</p>
                </div>
                <input type="password" id="passInput" placeholder="Masukkan Password" class="w-full p-4 border-2 rounded-2xl mb-4 focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none text-center text-xl font-bold transition-all">
                <button onclick="login()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-2xl font-black shadow-lg uppercase tracking-wider">Login</button>
            </div>
        </div>

        <header class="bg-white border-b p-4 flex justify-between items-center shadow-sm z-10">
            <div class="w-1/2 relative">
                <span class="absolute left-4 top-2.5 text-gray-400">üîç</span>
                <input type="text" id="globalSearch" onkeyup="filterTable()" placeholder="Cari merk, ukuran, atau nama barang..." class="w-full pl-12 pr-4 py-2.5 bg-gray-50 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all font-medium">
            </div>
            
            <div id="adminTools" class="hidden flex items-center gap-4">
                <label class="bg-slate-800 hover:bg-black text-white px-6 py-2.5 rounded-xl text-xs font-black cursor-pointer transition-all shadow-md uppercase">
                    Import Excel
                    <input type="file" id="importExcel" class="hidden" accept=".xlsx, .xls">
                </label>
            </div>
        </header>

        <section id="homePage" class="p-6 overflow-y-auto">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 border-b border-slate-200">
                        <tr id="tableHeader" class="text-slate-500 text-[11px] uppercase font-black tracking-widest"></tr>
                    </thead>
                    <tbody id="tableBody" class="text-slate-700 divide-y divide-slate-100">
                        <tr><td colspan="5" class="p-20 text-center text-slate-300 font-bold italic">Menunggu data dari Cloud...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="pesananPage" class="hidden p-6 overflow-y-auto bg-gray-50">
            <div class="max-w-5xl mx-auto bg-white p-10 rounded-3xl shadow-xl border border-slate-100">
                <div class="flex justify-between items-end border-b-4 border-slate-900 pb-4 mb-8">
                    <h2 class="text-3xl font-black text-slate-900 uppercase">Buat Pesanan</h2>
                    <p class="text-slate-400 font-bold text-sm" id="liveClock"></p>
                </div>
                
                <div class="mb-10">
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">Pilih Toko / Customer</label>
                    <input type="text" id="searchCustomer" list="customerList" placeholder="Ketik nama toko atau customer..." class="w-full p-5 border-2 border-slate-100 rounded-2xl bg-slate-50 focus:border-blue-500 focus:bg-white outline-none transition-all font-bold text-lg">
                    <datalist id="customerList"></datalist>
                </div>

                <div id="orderItems" class="space-y-4"></div>

                <button onclick="addItemRow()" class="mt-8 flex items-center gap-3 text-blue-600 font-black hover:bg-blue-50 p-3 rounded-xl transition-all uppercase text-sm border-2 border-dashed border-blue-200 w-full justify-center">
                    <span>+ Tambah Baris Barang</span>
                </button>

                <div class="mt-12 p-8 bg-slate-900 rounded-3xl text-white flex justify-between items-center shadow-2xl">
                    <div class="flex gap-10">
                        <div>
                            <p class="text-slate-400 text-[10px] uppercase font-black tracking-widest mb-1">Total QTY</p>
                            <p class="text-3xl font-black text-blue-400" id="totalQtyDisplay">0</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-[10px] uppercase font-black tracking-widest mb-1">Total Harga</p>
                            <p class="text-3xl font-black text-green-400" id="totalPriceDisplay">Rp 0</p>
                        </div>
                    </div>
                    <button onclick="generateOrder()" class="bg-blue-500 hover:bg-blue-400 text-white px-12 py-5 rounded-2xl font-black shadow-xl uppercase tracking-tighter transition-all">Generate & Copy</button>
                </div>
            </div>
        </section>
    </main>

    <script>
        const GITHUB_TOKEN = "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";
        const REPO_OWNER = "USERNAME_ANDA"; 
        const REPO_NAME = "NAMA_REPO_ANDA";   
        const DATA_FILE = "data.json";

        let currentUser = null;
        let masterData = { keramik: [], eksternal: [], customer: [] };

        const USERS = {
            'mnu123': { role: 'admin', access: 'all' },
            'dare123': { role: 'user_keramik', access: ['asia tile', 'platinum', 'infiniti', 'titanium'] },
            'change123': { role: 'user_eks', access: ['mortindo', 'drymix', 'aer', 'air', 'ava', 'pacific paint'] }
        };

        function login() {
            const pass = document.getElementById('passInput').value.toLowerCase();
            if (USERS[pass]) {
                currentUser = USERS[pass];
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('userStatus').innerText = `ACCESS: ${currentUser.role.toUpperCase()}`;
                if(currentUser.role === 'admin') document.getElementById('adminTools').classList.remove('hidden');
                fetchFromGithub();
            } else { alert("‚ùå Password Salah!"); }
        }

        async function fetchFromGithub() {
            try {
                const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE}`;
                const res = await fetch(url, { headers: { Authorization: `token ${GITHUB_TOKEN}` } });
                const data = await res.json();
                masterData = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                renderTable();
                updateCustomerDatalist();
            } catch (e) { console.log("Data Cloud tidak ditemukan."); }
        }

        function getFilteredData() {
            let combined = [...(masterData.keramik || []), ...(masterData.eksternal || [])];
            if (currentUser.role === 'admin') return combined;
            return combined.filter(item => currentUser.access.some(acc => item.Merk?.toLowerCase().includes(acc.toLowerCase())));
        }

        function renderTable() {
            const data = getFilteredData();
            const head = document.getElementById('tableHeader');
            const body = document.getElementById('tableBody');
            body.innerHTML = "";
            const cols = ["Nama", "Lot", "Merk", "Ukuran", "QTY"];
            head.innerHTML = cols.map(c => `<th class="p-5">${c}</th>`).join('');
            if(!data.length) { body.innerHTML = `<tr><td colspan="5" class="p-20 text-center text-slate-300 italic">No data.</td></tr>`; return; }
            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 border-b border-slate-100 transition-colors";
                tr.innerHTML = cols.map(c => `<td class="p-5 font-bold text-slate-800">${item[c] || '-'}</td>`).join('');
                body.appendChild(tr);
            });
        }

        function formatRupiah(angka) {
            let number_string = angka.replace(/[^,\d]/g, '').toString(),
            split = number_string.split(','),
            sisa = split[0].length % 3,
            rupiah = split[0].substr(0, sisa),
            ribuan = split[0].substr(sisa).match(/\d{3}/gi);
            if (ribuan) {
                let separator = sisa ? '.' : '';
                rupiah += separator + ribuan.join('.');
            }
            return split[1] != undefined ? rupiah + ',' + split[1] : rupiah;
        }

        function handlePriceInput(input) {
            input.value = formatRupiah(input.value);
            calcTotal();
        }

        function addItemRow() {
            const container = document.getElementById('orderItems');
            const id = Date.now();
            const filteredStok = getFilteredData();
            const uniqueNames = [...new Set(filteredStok.map(s => s.Nama))];

            const row = document.createElement('div');
            row.className = "order-item flex gap-3 items-center bg-white p-4 rounded-2xl border-2 border-slate-100 shadow-sm transition-all hover:border-blue-200";
            row.innerHTML = `
                <div class="flex-[2]">
                    <input type="text" list="stok-${id}" onchange="updateLotDropdown(this)" placeholder="Nama Barang..." class="item-name w-full p-3 border-2 border-slate-50 rounded-xl bg-slate-50 outline-none focus:border-blue-500 font-bold text-slate-800">
                    <datalist id="stok-${id}">${uniqueNames.map(n => `<option value="${n}">`).join('')}</datalist>
                </div>
                <div class="flex-1">
                    <select class="item-lot w-full p-3 border-2 border-slate-50 rounded-xl bg-slate-50 font-bold text-slate-600 outline-none">
                        <option value="">Pilih Lot</option>
                    </select>
                </div>
                <input type="number" oninput="calcTotal()" placeholder="0" class="item-qty w-24 p-3 border-2 border-slate-50 rounded-xl font-black text-blue-600 text-center outline-none">
                <div class="w-44 relative">
                    <span class="absolute left-3 top-3.5 text-slate-400 text-xs font-black">Rp</span>
                    <input type="text" oninput="handlePriceInput(this)" placeholder="Harga" class="item-price w-full pl-10 p-3 border-2 border-slate-50 rounded-xl font-bold text-slate-700 outline-none">
                </div>
                <button onclick="this.parentElement.remove(); calcTotal();" class="text-red-300 hover:text-red-600 font-black text-2xl px-2">√ó</button>
            `;
            container.appendChild(row);
        }

        function updateLotDropdown(input) {
            const row = input.closest('.order-item');
            const lotSelect = row.querySelector('.item-lot');
            const filteredStok = getFilteredData();
            const availableLots = filteredStok.filter(s => s.Nama === input.value);
            lotSelect.innerHTML = '<option value="">Pilih Lot</option>';
            availableLots.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.Lot || '-';
                opt.text = `${item.Lot || '-'} (Sisa: ${item.QTY})`;
                lotSelect.appendChild(opt);
            });
        }

        function calcTotal() {
            let totalQty = 0; let totalPrice = 0;
            document.querySelectorAll('.order-item').forEach(row => {
                const qty = parseInt(row.querySelector('.item-qty').value) || 0;
                const pVal = parseInt(row.querySelector('.item-price').value.replace(/\./g, '')) || 0;
                totalQty += qty; totalPrice += (qty * pVal);
            });
            document.getElementById('totalQtyDisplay').innerText = totalQty;
            document.getElementById('totalPriceDisplay').innerText = 'Rp ' + formatRupiah(totalPrice.toString());
        }

        function generateOrder() {
            const tokoInput = document.getElementById('searchCustomer').value;
            if(!tokoInput) { alert("Pilih Toko!"); return; }

            const namaTokoOnly = tokoInput.split('(')[0].trim();
            let itemsTxt = "";
            let totalQ = 0;
            let totalH = 0;

            document.querySelectorAll('.order-item').forEach(row => {
                const n = row.querySelector('.item-name').value;
                const l = row.querySelector('.item-lot').value;
                const q = parseInt(row.querySelector('.item-qty').value) || 0;
                const pDisplay = row.querySelector('.item-price').value;
                const pVal = parseInt(pDisplay.replace(/\./g, '')) || 0;

                if(n && q > 0) {
                    itemsTxt += `${n} / ${l || '-'} / ${q} / ${pDisplay}\n`;
                    totalQ += q;
                    totalH += (q * pVal);
                }
            });

            const sekarang = new Date();
            const tgl = sekarang.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            
            // Format jam dengan titik sebagai pemisah (HH.mm.ss)
            const jam = sekarang.getHours().toString().padStart(2, '0') + '.' + 
                        sekarang.getMinutes().toString().padStart(2, '0') + '.' + 
                        sekarang.getSeconds().toString().padStart(2, '0');

            const formatTotalHarga = formatRupiah(totalH.toString());

            const finalString = `Berikut Pesanan Via WA Toko *${namaTokoOnly.toUpperCase()}*\n\nMotif / Lot / QTY / Harga\n${itemsTxt}\nTotal QTY : ${totalQ}\nJumlah : Rp. ${formatTotalHarga}\n\nPekanbaru, ${tgl} ${jam}\nTerimakasih`;

            navigator.clipboard.writeText(finalString);
            alert("üìã PESANAN DISALIN!\nSilakan paste ke WhatsApp.");
        }

        document.getElementById('importExcel').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(evt) {
                const workbook = XLSX.read(evt.target.result, { type: 'binary' });
                if(workbook.Sheets["Data_Keramik"]) masterData.keramik = XLSX.utils.sheet_to_json(workbook.Sheets["Data_Keramik"]);
                if(workbook.Sheets["Data_Eksternal"]) masterData.eksternal = XLSX.utils.sheet_to_json(workbook.Sheets["Data_Eksternal"]);
                if(workbook.Sheets["Data_Customer"]) masterData.customer = XLSX.utils.sheet_to_json(workbook.Sheets["Data_Customer"]);
                renderTable(); updateCustomerDatalist(); saveToGithub(); 
            };
            reader.readAsBinaryString(file);
        });

        async function saveToGithub() {
            const url = `https://api.github.com/repos/${kososon}/${SOH}/contents/${DATA_FILE}`;
            try {
                let sha = "";
                const checkRes = await fetch(url, { headers: { Authorization: `token ${GITHUB_TOKEN}` } });
                if(checkRes.ok) { sha = (await checkRes.json()).sha; }
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(masterData, null, 2))));
                await fetch(url, {
                    method: "PUT",
                    headers: { Authorization: `token ${GITHUB_TOKEN}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ message: "SOH Update", content: content, sha: sha || undefined })
                });
                alert("‚úÖ Cloud Updated!");
            } catch (e) { alert("‚ùå Error Save."); }
        }

        function updateCustomerDatalist() {
            const list = document.getElementById('customerList');
            if(!masterData.customer) return;
            list.innerHTML = masterData.customer.map(c => `<option value="${c['nama toko']} (${c['nama customer']})">ID: ${c['id']}</option>`).join('');
        }

        function showPage(p) {
            document.getElementById('homePage').classList.toggle('hidden', p !== 'home');
            document.getElementById('pesananPage').classList.toggle('hidden', p !== 'pesanan');
            document.getElementById('btn-home').classList.toggle('active-tab', p === 'home');
            document.getElementById('btn-pesanan').classList.toggle('active-tab', p === 'pesanan');
        }

        function filterTable() {
            const v = document.getElementById('globalSearch').value.toLowerCase();
            document.querySelectorAll('#tableBody tr').forEach(r => r.style.display = r.innerText.toLowerCase().includes(v) ? '' : 'none');
        }

        setInterval(() => {
            const n = new Date();
            document.getElementById('liveClock').innerText = n.toLocaleString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }, 1000);
    </script>
</body>
</html>
