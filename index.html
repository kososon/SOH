<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SOH Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .active-nav { color: #3b82f6; border-top: 3px solid #3b82f6; }
        .hidden { display: none; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .custom-scroll::-webkit-scrollbar { height: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 flex flex-col h-screen overflow-hidden text-slate-900">

    <div id="loginPage" class="fixed inset-0 bg-slate-950 z-[100] flex items-center justify-center p-6">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm border border-slate-200">
            <div class="text-center mb-6">
                <h2 class="text-4xl font-black text-slate-900 tracking-tighter">SOH</h2>
                <p class="text-xs text-slate-500 uppercase font-bold tracking-widest mt-1">Mobile Access</p>
            </div>
            <input type="password" id="passInput" placeholder="Password" class="w-full p-4 border-2 rounded-2xl mb-4 focus:ring-4 focus:ring-blue-100 outline-none text-center text-xl font-bold transition-all bg-slate-50">
            <button onclick="login()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black shadow-lg active:scale-95 transition-all uppercase mb-6">Login</button>
            <div class="text-center">
                <p class="text-[10px] text-slate-400 italic font-medium">Powered by Wilson V.1.0</p>
            </div>
        </div>
    </div>

    <header class="bg-white border-b p-4 shadow-sm z-10">
        <div class="flex items-center justify-between mb-3">
            <h1 class="text-2xl font-black text-blue-600 tracking-tighter">SOH</h1>
            <div class="flex items-center gap-2">
                <div id="adminTools" class="hidden">
                    <label id="btnImportLabel" class="bg-slate-800 text-white px-3 py-2 rounded-lg text-[10px] font-black cursor-pointer uppercase">
                        Import
                        <input type="file" id="importExcel" class="hidden" accept=".xlsx, .xls">
                    </label>
                </div>
                <button onclick="logout()" id="btnLogout" class="hidden bg-red-50 text-red-600 px-3 py-2 rounded-lg text-[10px] font-black uppercase border border-red-100">
                    Logout
                </button>
            </div>
        </div>
        <div class="relative">
            <span class="absolute left-3 top-2.5 text-gray-400">üîç</span>
            <input type="text" id="globalSearch" onkeyup="filterTable()" placeholder="Cari barang atau merk..." class="w-full pl-9 pr-4 py-2 bg-slate-100 border-none rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm font-medium">
        </div>
    </header>

    <main class="flex-1 overflow-y-auto pb-24">
        <section id="homePage" class="p-4">
            <div id="syncStatus" class="text-[9px] font-bold text-blue-500 mb-2 hidden uppercase tracking-widest text-center">üîÑ Sinkronisasi...</div>
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto custom-scroll">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-slate-50 border-b">
                            <tr id="tableHeader" class="text-slate-500 font-black uppercase tracking-tighter"></tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-slate-100 font-bold text-slate-700">
                            <tr><td colspan="4" class="p-10 text-center italic text-slate-400">Silakan login untuk memuat data.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="pesananPage" class="hidden p-4">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                <div class="mb-6">
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-2">Customer</label>
                    <input type="text" id="searchCustomer" list="customerList" placeholder="Nama Toko..." class="w-full p-3 bg-slate-50 border-2 border-slate-100 rounded-xl focus:border-blue-500 outline-none font-bold text-slate-800">
                    <datalist id="customerList"></datalist>
                </div>
                <div id="orderItems" class="space-y-4"></div>
                <button onclick="addItemRow()" class="mt-6 flex items-center gap-2 text-blue-600 font-black p-3 rounded-xl border-2 border-dashed border-blue-200 w-full justify-center text-xs uppercase">
                    + Tambah Item
                </button>
                <div class="mt-8 p-5 bg-slate-900 rounded-2xl text-white">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <p class="text-slate-400 text-[9px] uppercase font-black">Total QTY</p>
                            <p class="text-xl font-black text-blue-400" id="totalQtyDisplay">0</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-[9px] uppercase font-black">Total Harga</p>
                            <p class="text-xl font-black text-green-400" id="totalPriceDisplay">Rp 0</p>
                        </div>
                    </div>
                    <button onclick="generateOrder()" class="w-full bg-blue-500 hover:bg-blue-400 py-4 rounded-xl font-black uppercase tracking-tighter active:scale-95 transition-all">Generate & Copy</button>
                </div>
                <p id="liveClock" class="text-[9px] text-center mt-4 text-slate-400 font-bold uppercase"></p>
            </div>
        </section>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around p-2 pb-6 z-50">
        <button onclick="showPage('home')" id="btn-home" class="flex flex-col items-center gap-1 active-nav px-6 pt-2">
            <span class="text-xl">üè†</span>
            <span class="text-[10px] font-black uppercase">Stok</span>
        </button>
        <button onclick="showPage('pesanan')" id="btn-pesanan" class="flex flex-col items-center gap-1 px-6 pt-2">
            <span class="text-xl">üìù</span>
            <span class="text-[10px] font-black uppercase">Order</span>
        </button>
    </nav>

    <script>
        // KONFIGURASI GITHUB
        const GITHUB_TOKEN = "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";
        const REPO_OWNER = "kososon"; 
        const REPO_NAME = "SOH";   
        const DATA_FILE = "data.json";

        let currentUser = null;
        let masterData = { keramik: [], eksternal: [], customer: [] };
        let refreshInterval = null;

        const USERS = {
            'mnu123': { role: 'admin' },
            'dare123': { role: 'sales' }
        };

        function login() {
            const pass = document.getElementById('passInput').value.toLowerCase();
            if (USERS[pass]) {
                currentUser = USERS[pass];
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('btnLogout').classList.remove('hidden');
                if(currentUser.role === 'admin') document.getElementById('adminTools').classList.remove('hidden');
                
                // Ambil data pertama kali
                fetchFromGithub(true); 
                
                // Set interval untuk cek data baru (setiap 20 detik)
                if(!refreshInterval) {
                    refreshInterval = setInterval(() => fetchFromGithub(false), 20000);
                }
            } else { alert("‚ùå Password Salah!"); }
        }

        function logout() {
            if(confirm("Logout dari aplikasi?")) {
                clearInterval(refreshInterval);
                refreshInterval = null;
                location.reload(); // Reload untuk reset state total
            }
        }

        // FUNGSI AMBIL DATA (PENGGUNAAN API GITHUB YANG BENAR)
        async function fetchFromGithub(forceRender = false) {
            if (!currentUser) return;
            const statusEl = document.getElementById('syncStatus');
            statusEl.classList.remove('hidden');

            try {
                // Ambil data lewat API utama (bukan raw) untuk mendapatkan SHA terbaru agar tidak kena cache browser
                const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE}?t=${new Date().getTime()}`;
                const res = await fetch(url, {
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json' }
                });

                if (res.ok) {
                    const json = await res.json();
                    const content = JSON.parse(decodeURIComponent(escape(atob(json.content))));
                    
                    // Cek jika data berbeda dengan yang ada di memori
                    if (JSON.stringify(content) !== JSON.stringify(masterData) || forceRender) {
                        masterData = content;
                        renderTable();
                        updateCustomerDatalist();
                        console.log("‚úÖ Data Terupdate!");
                    }
                }
            } catch (e) {
                console.error("Gagal sinkronisasi:", e);
            } finally {
                setTimeout(() => statusEl.classList.add('hidden'), 1000);
            }
        }

        function renderTable() {
            const data = [...(masterData.keramik || []), ...(masterData.eksternal || [])];
            const head = document.getElementById('tableHeader');
            const body = document.getElementById('tableBody');
            
            head.innerHTML = `<th class="p-4">Nama</th><th class="p-4">Lot</th><th class="p-4">Merk</th><th class="p-4">QTY</th>`;
            
            if (data.length === 0) {
                body.innerHTML = `<tr><td colspan="4" class="p-10 text-center italic text-slate-400">Data kosong di Cloud. Admin perlu Import.</td></tr>`;
                return;
            }

            body.innerHTML = data.map(item => `
                <tr class="active:bg-slate-50 border-b">
                    <td class="p-4">${item.Nama || '-'}</td>
                    <td class="p-4 text-slate-500">${item.Lot || '-'}</td>
                    <td class="p-4 uppercase text-[10px]">${item.Merk || '-'}</td>
                    <td class="p-4 text-blue-600 font-black">${item.QTY || 0}</td>
                </tr>
            `).join('');
        }

        // FUNGSI SIMPAN DATA (HANYA UNTUK ADMIN)
        async function saveToGithub() {
            const btnLabel = document.getElementById('btnImportLabel');
            btnLabel.innerText = "Saving...";
            btnLabel.style.opacity = "0.5";

            const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE}`;
            
            try {
                // 1. Dapatkan SHA terbaru (Wajib untuk update file di GitHub)
                const checkRes = await fetch(url, { headers: { Authorization: `token ${GITHUB_TOKEN}` } });
                let sha = "";
                if(checkRes.ok) {
                    const fileData = await checkRes.json();
                    sha = fileData.sha;
                }

                // 2. Encode data ke Base64
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(masterData, null, 2))));
                
                // 3. Kirim ke GitHub
                const saveRes = await fetch(url, {
                    method: "PUT",
                    headers: { 
                        Authorization: `token ${GITHUB_TOKEN}`, 
                        "Content-Type": "application/json" 
                    },
                    body: JSON.stringify({ 
                        message: `Update Data by Admin: ${new Date().toLocaleString()}`, 
                        content: content, 
                        sha: sha 
                    })
                });

                if(saveRes.ok) {
                    alert("‚úÖ Berhasil Simpan ke Cloud!");
                } else {
                    const err = await saveRes.json();
                    alert("‚ùå Gagal Simpan: " + err.message);
                }
            } catch (e) {
                alert("‚ùå Terjadi kesalahan jaringan.");
            } finally {
                btnLabel.innerText = "Import";
                btnLabel.style.opacity = "1";
            }
        }

        // EVENT LISTENER IMPORT
        document.getElementById('importExcel').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    const workbook = XLSX.read(evt.target.result, { type: 'binary' });
                    const newData = {
                        keramik: XLSX.utils.sheet_to_json(workbook.Sheets["Data_Keramik"] || []),
                        eksternal: XLSX.utils.sheet_to_json(workbook.Sheets["Data_Eksternal"] || []),
                        customer: XLSX.utils.sheet_to_json(workbook.Sheets["Data_Customer"] || [])
                    };

                    if(newData.keramik.length === 0 && newData.eksternal.length === 0) {
                        alert("‚ö†Ô∏è Format file salah atau Sheet kosong!");
                        return;
                    }

                    masterData = newData; // Update memori lokal
                    renderTable();        // Render ke layar
                    saveToGithub();       // Simpan ke cloud
                } catch (err) {
                    alert("‚ùå Gagal membaca file Excel!");
                }
            };
            reader.readAsBinaryString(file);
        });

        // FUNGSI LAINNYA (Pesanan, Filter, Clock)
        function showPage(p) {
            document.getElementById('homePage').classList.toggle('hidden', p !== 'home');
            document.getElementById('pesananPage').classList.toggle('hidden', p !== 'pesanan');
            document.getElementById('btn-home').classList.toggle('active-nav', p === 'home');
            document.getElementById('btn-pesanan').classList.toggle('active-nav', p === 'pesanan');
            if(currentUser) fetchFromGithub(false); 
        }

        function filterTable() {
            const v = document.getElementById('globalSearch').value.toLowerCase();
            document.querySelectorAll('#tableBody tr').forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(v) ? '' : 'none';
            });
        }

        function formatRupiah(angka) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);
        }

        function addItemRow() {
            const container = document.getElementById('orderItems');
            const id = Date.now();
            const allStok = [...(masterData.keramik || []), ...(masterData.eksternal || [])];
            const uniqueNames = [...new Set(allStok.map(s => s.Nama))];
            
            const row = document.createElement('div');
            row.className = "order-item bg-slate-50 p-4 rounded-xl border border-slate-100 relative mb-4";
            row.innerHTML = `
                <button onclick="this.parentElement.remove(); calcTotal();" class="absolute -top-2 -right-2 bg-red-500 text-white w-6 h-6 rounded-full text-xs font-black">√ó</button>
                <div class="space-y-3">
                    <input type="text" list="stok-${id}" onchange="updateLotDropdown(this)" placeholder="Pilih Motif..." class="item-name w-full p-3 rounded-lg border-2 border-white focus:border-blue-500 outline-none font-bold text-sm">
                    <datalist id="stok-${id}">${uniqueNames.map(n => `<option value="${n}">`).join('')}</datalist>
                    <div class="grid grid-cols-2 gap-2">
                        <select class="item-lot p-3 rounded-lg border-2 border-white text-xs font-bold outline-none"><option value="">Pilih Lot</option></select>
                        <input type="number" oninput="calcTotal()" placeholder="QTY" class="item-qty p-3 rounded-lg border-2 border-white text-center font-black text-blue-600 outline-none">
                    </div>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-[10px] font-black text-slate-400">Rp</span>
                        <input type="text" oninput="this.value = this.value.replace(/[^0-9]/g, ''); calcTotal();" placeholder="Harga" class="item-price w-full pl-8 p-3 rounded-lg border-2 border-white font-bold text-sm outline-none">
                    </div>
                </div>`;
            container.appendChild(row);
        }

        function updateLotDropdown(input) {
            const row = input.closest('.order-item');
            const lotSelect = row.querySelector('.item-lot');
            const allStok = [...(masterData.keramik || []), ...(masterData.eksternal || [])];
            const lots = allStok.filter(s => s.Nama === input.value);
            lotSelect.innerHTML = '<option value="">Pilih Lot</option>' + lots.map(item => `<option value="${item.Lot || '-'}">${item.Lot || '-'} (${item.QTY})</option>`).join('');
        }

        function calcTotal() {
            let qTotal = 0, pTotal = 0;
            document.querySelectorAll('.order-item').forEach(row => {
                const q = parseInt(row.querySelector('.item-qty').value) || 0;
                const p = parseInt(row.querySelector('.item-price').value) || 0;
                qTotal += q; pTotal += (q * p);
            });
            document.getElementById('totalQtyDisplay').innerText = qTotal;
            document.getElementById('totalPriceDisplay').innerText = formatRupiah(pTotal);
        }

        function updateCustomerDatalist() {
            if(!masterData.customer) return;
            document.getElementById('customerList').innerHTML = masterData.customer.map(c => `<option value="${c['nama toko']} (${c['nama customer']})">`).join('');
        }

        setInterval(() => {
            const clockEl = document.getElementById('liveClock');
            if(clockEl) clockEl.innerText = new Date().toLocaleString('id-ID');
        }, 1000);
    </script>
</body>
</html>
